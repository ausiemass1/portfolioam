<div class="cart-container">

  <h2>Your Trolley</h2>

  <div class="cart-header">
    <span>Product</span>
    <span>Price</span>
    <span>Quantity</span>
    <span>Item total</span>
    <span></span>
  </div>

  <% cart.items.forEach(item=> { %>
    <div class="cart-row">

      <div class="product-cell">
        <img src="<%= item.image %>" width="60" />
        <strong>
          <%= item.name %>
        </strong>
      </div>

      <div>$<%= item.price.toFixed(2) %>
      </div>

      <div class="qty-cell">
        <form action="/cart/decrement/<%= item.productId %>" method="POST">
          <button class="qty-btn">−</button>
        </form>

        <span data-qty-id="<%= item.productId %>">
          <%= item.quantity %>
        </span>

    
          <button class="qty-btn increment" data-id="<%= item.productId %>" data-price="<%= item.price %>">+</button>
     
      </div>

      <div data-total-id="<%= item.productId %>">
        $<%= (item.price * item.quantity).toFixed(2) %>
      </div>

      <div>
        <form action="/cart/remove/<%= item.productId %>" method="POST">
          <button class="remove-btn">✕</button>
        </form>
      </div>

    </div>
    <% }) %>

      <!-- TOTALS -->
      <div class="cart-summary">
        <div class="summary-row">
          <span>Subtotal</span>
          <span id="cart-subtotal">
            $<%= cart.totalPrice.toFixed(2) %>
          </span>
        </div>
      
        <div class="summary-row total">
          <strong>Total</strong>
          <strong id="cart-total">
            $<%= cart.totalPrice.toFixed(2) %>
          </strong>
        </div>
      </div>
      

      <!-- ACTION BUTTONS -->
      <div class="cart-actions">
        <a href="/" class="btn outline">Continue shopping</a>

        <% if (cart && cart.totalQuantity> 0) { %>

          <form action="/cart/clear" method="POST">
            <button class="btn danger">Clear trolley</button>
          </form>

          <a href="/stripe/checkout" class="btn primary">Checkout</a>

          <% } %>
      </div>

</div>

<script>
  document.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("increment")) return;
  
    e.preventDefault();
  
    const productId = e.target.dataset.id;
  
    try {
      const res = await fetch(`/cart/increment/${productId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });
  
      const data = await res.json();
      if (!data.success) return;
  
      // Update item quantity
      document.querySelector(
        `[data-qty-id="${productId}"]`
      ).innerText = data.item.quantity;
  
      // Update item total
      document.querySelector(
        `[data-total-id="${productId}"]`
      ).innerText =
        `$${(data.item.price * data.item.quantity).toFixed(2)}`;
  
      // Update subtotal + total
      document.querySelector("#cart-subtotal").innerText =
        `$${data.cart.totalPrice.toFixed(2)}`;
  
      document.querySelector("#cart-total").innerText =
        `$${data.cart.totalPrice.toFixed(2)}`;
  
    } catch (err) {
      console.error("Cart update failed", err);
    }
  });
  </script>
  